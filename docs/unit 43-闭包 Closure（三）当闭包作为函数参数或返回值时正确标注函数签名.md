## é—­åŒ… Closure

> æœ¬ç« å†…å®¹è¾ƒé•¿ï¼Œä¸”åœ¨æœ¬ç« å†…å®¹å°¾éƒ¨æ›´æ–°äº†å¯¹é—­åŒ…çš„è®¤è¯†ï¼Œè¯»è€…åº”è¯»å®Œå…¨ç« ï¼Œä¸è¦å–å…¶ä¸­éƒ¨åˆ†ã€‚

é—­åŒ…æ˜¯ä¸€ç§åŒ¿åå‡½æ•°ï¼Œå®ƒå¯ä»¥èµ‹å€¼ç»™å˜é‡ä¹Ÿå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶å®ƒå‡½æ•°ï¼Œä¸åŒäºå‡½æ•°çš„æ˜¯ï¼Œå®ƒå…è®¸æ•è·è°ƒç”¨è€…ä½œç”¨åŸŸä¸­çš„å€¼ã€‚

Rust é—­åŒ…åœ¨å½¢å¼ä¸Šå€Ÿé‰´äº† Smalltalk å’Œ Ruby è¯­è¨€ï¼Œä¸å‡½æ•°æœ€å¤§çš„ä¸åŒå°±æ˜¯å®ƒçš„å‚æ•°æ˜¯é€šè¿‡ |parm1| çš„å½¢å¼è¿›è¡Œå£°æ˜ï¼Œå¦‚æœæ˜¯å¤šä¸ªå‚æ•°å°± |param1, param2,...|ï¼Œé—­åŒ…çš„å½¢å¼å®šä¹‰ï¼š

```rust
|param1, param2,...| {
    è¯­å¥1;
    è¯­å¥2;
    è¿”å›è¡¨è¾¾å¼
}
```

### é—­åŒ…ä½œä¸ºå‡½æ•°è¿”å›å€¼

åœ¨å®ç° `Cacher` ä¸­æˆ‘ä»¬å°†é—­åŒ…ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰ï¼Œç°åœ¨è€ƒè™‘å¦‚ä½•å°†é—­åŒ…åº”ç”¨åœ¨å‡½æ•°çš„è¿”å›å€¼ä¸Šï¼Œå› ä¸ºåªæœ‰è¿™æ ·ï¼Œæ‰èƒ½å°†å†…éƒ¨å€¼ä¼ é€’å‡ºå»ã€‚

é—­åŒ…åœ¨ Rust ä¸­æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„ç‰¹æ€§ï¼šæ¯ä¸ªé—­åŒ…éƒ½æœ‰å…¶è‡ªå·±ç‹¬ç‰¹çš„åŒ¿åç±»å‹ï¼ˆè¿™ä¸ªç±»å‹å°±æ˜¯ç±»ä¼¼ `i32 String` çš„ä¸€ç§æ•°æ®æ ¼å¼ç±»å‹ï¼‰ï¼Œè¿™æ˜¯å› ä¸º**é—­åŒ…ç±»å‹ä¸ä»…ä»…æ˜¯ç”±å…¶å‚æ•°å’Œè¿”å›ç±»å‹å®šä¹‰**çš„ï¼Œè¿˜åŒ…æ‹¬å®ƒæ•è·çš„ç¯å¢ƒã€‚æ¯ä¸ªé—­åŒ…æ ¹æ®å…¶æ•è·çš„ç¯å¢ƒï¼ˆå˜é‡ã€ç”Ÿå‘½å‘¨æœŸç­‰ï¼‰å…·æœ‰ä¸åŒçš„ç±»å‹ã€‚
å³ä½¿ä¸¤ä¸ªé—­åŒ…æœ‰ç›¸åŒçš„ç­¾åï¼Œå®ƒä»¬ä¹Ÿè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„ç±»å‹ã€‚è¿™æ„å‘³ç€ç›´æ¥è¿”å›é—­åŒ…ç±»å‹ï¼ˆ`Fn(i32) -> i32`ï¼‰æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºé—­åŒ…çš„å…·ä½“ç±»å‹æ˜¯æœªçŸ¥çš„ï¼Œä¸”æ— æ³•ç›´æ¥å‘½åã€‚

#### æ­£ç¡®æ ‡æ³¨é—­åŒ…ä½œä¸ºå‡½æ•°è¿”å›å€¼

ä½¿ç”¨ impl Trait è¯­æ³•å…è®¸æˆ‘ä»¬è¿”å›ä¸€ä¸ªå®ç°äº†æŒ‡å®š trait çš„ç±»å‹ï¼Œè€Œä¸éœ€è¦æŒ‡å®šå…·ä½“çš„ç±»å‹ã€‚ï¼ˆimpl Trait å½¢å¼æ¥è¯´æ˜ä¸€ä¸ªå‡½æ•°è¿”å›äº†ä¸€ä¸ªç±»å‹ï¼Œè¯¥ç±»å‹å®ç°äº†æŸä¸ªç‰¹å¾ï¼Œå¤–éƒ¨ä½¿ç”¨æ—¶åªèƒ½ä½¿ç”¨è¯¥ç‰¹å¾å·²å£°æ˜çš„å±æ€§ï¼‰(å‡½æ•°è¿”å›ä¸­çš„ impl trait)[https://course.rs/basic/trait/trait.html#%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E4%B8%AD%E7%9A%84-impl-trait]
ä½¿ç”¨ `impl trait` å½¢å¼å°†é—­åŒ…æ ‡è¯†ä¸ºå®ç°äº†æŸä¸ªç‰¹å¾çš„ç±»å‹åå°±å¯ä»¥è¿”å›ã€‚åœ¨é—­åŒ…çš„åœºæ™¯ä¸­ï¼ŒFnã€FnMutã€FnOnce å®ƒä»¬åˆ†åˆ«å¯¹åº”ä¸åŒçš„é—­åŒ…ç±»å‹ã€‚é€šè¿‡è¿”å› impl Fn(å‚æ•°ç±»å‹) -> è¿”å›å€¼ç±»å‹ï¼Œè¿™å°†å‘Šè¯‰ Rust ç¼–è¯‘å™¨ï¼Œè¿”å›ä¸€ä¸ªå®ç°äº† Fn trait çš„ç±»å‹ï¼Œä½†ä¸æŒ‡å®šå…·ä½“æ˜¯å“ªä¸ªç±»å‹ã€‚
ç®€è€Œè¨€ä¹‹ï¼Œimpl å…³é”®è¯çš„ä½¿ç”¨æ˜¯å› ä¸ºé—­åŒ…çš„ç±»å‹æ˜¯åŒ¿åä¸”ä¸å¯ç›´æ¥å‘½åçš„ï¼Œè€Œ impl Trait è¯­æ³•å…è®¸æˆ‘ä»¬ä»¥ä¸€ç§æŠ½è±¡çš„æ–¹å¼è¿”å›å®ç°äº†ç‰¹å®š trait çš„é—­åŒ…ï¼Œè€Œæ— éœ€å…³å¿ƒé—­åŒ…çš„å…·ä½“ç±»å‹ã€‚è¿™å¤§å¤§å¢åŠ äº†ä»£ç çš„çµæ´»æ€§å’Œå¯é‡ç”¨æ€§ã€‚

ä¸ºä»€ä¹ˆé—­åŒ…ä½œä¸ºå‡½æ•°çš„å‚æ•°æ—¶ä¸éœ€è¦æ˜¾å¼çš„æŒ‡å®š impl ï¼Ÿ
å½“é—­åŒ…ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°æ—¶ï¼Œ**ä¸éœ€è¦**ä½¿ç”¨ impl å…³é”®å­—ï¼Œæ˜¯å› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹å¯ä»¥ç›´æ¥æŒ‡å®šé—­åŒ…å‚æ•°éµå¾ªçš„ç‰¹å®š traitï¼ˆå¦‚ Fnã€FnMut æˆ– FnOnceï¼‰ã€‚
è¿™æ˜¯é€šè¿‡ä½¿ç”¨**trait ç•Œå®šï¼ˆtrait boundsï¼‰**æ¥å®ç°çš„(ç®€å•ç†è§£ä¸ºè‡ªåŠ¨æ¨æ–­å’Œå®ç°)ï¼Œå®ƒå…è®¸å‡½æ•°æ¥å—ä»»ä½•å®ç°äº†æŒ‡å®š trait çš„ç±»å‹ã€‚è¿™ç§æ–¹å¼æä¾›äº†è¶³å¤Ÿçš„çµæ´»æ€§ï¼ŒåŒæ—¶é¿å…äº† impl Trait åœ¨å‚æ•°ä½ç½®çš„ä½¿ç”¨ã€‚

```rust
fn factory() -> impl Fn(i32) -> i32 {
    let num = 5;
    move |x| x + num
}

let f = factory();
let answer = f(1);
assert_eq!(6, answer);
```

ç”¨ `impl trait` å½¢å¼å®ç°é—­åŒ…ä½œä¸ºè¿”å›å€¼è¿”å›ï¼Œæœ€å¤§çš„é—®é¢˜æ˜¯ `impl trait` è¦æ±‚è¿”å›åªèƒ½æœ‰ä¸€ä¸ªå…·ä½“çš„ç±»å‹ã€‚è€Œé—­åŒ…å³ä½¿ç­¾åä¸€è‡´ä¹Ÿå¯èƒ½æ˜¯ä¸åŒçš„ç±»å‹ã€‚

```rust
ç¼–è¯‘é”™è¯¯ error
fn factory(x: i32) -> impl Fn(i32) -> i32 {
    let num = 5;
    if x > 1 {
        |x| x + num
     } else {
         |x| x - num
     }
}
```

ä¸ impl trait ç›¸å¯¹åº”çš„ï¼ŒåŠ¨æ€ç‰¹å¾å¯¹è±¡ä¸é™åˆ¶æŸä¸€ä¸ªå…·ä½“çš„ç±»å‹ï¼Œå› æ­¤å¯æ”¹ä¸ºä½¿ç”¨åŠ¨æ€ç‰¹å¾å¯¹è±¡è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

```rust
fn factory(x:i32) -> Box<dyn Fn(i32) -> i32> {
    let num = 5;
    if x > 1{
        Box::new(move |x| x + num) // ä»…å®ç°äº†Fnç‰¹å¾ï¼Œéœ€è¦å°†æ‰€æœ‰æƒå¼ºåˆ¶ç§»å…¥
    } else {
        Box::new(move |x| x - num)
    }
}
```

å½“é—­åŒ…ä½œä¸ºå‡½æ•°å‚æ•°æˆ–å‡½æ•°è¿”å›å€¼æ—¶å¦‚ä½•æ­£ç¡®çš„æ ‡æ³¨å‡½æ•°ç­¾åï¼Ÿ

é¦–å…ˆï¼ŒRust è¦æ±‚å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼çš„å†…å­˜å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› æ­¤é—­åŒ…ä½œä¸º Traitï¼Œå®ƒçš„å†…å­˜å¤§å°ä¸å›ºå®šï¼Œå¦‚ `Fn(i32) -> i32` æ˜¯ä¸èƒ½å¤Ÿç›´æ¥ä½œä¸ºå‚æ•°å’Œè¿”å›å€¼çš„ã€‚
ä½†æœ‰ç‰¹æ®Šæƒ…å†µï¼ŒæŠŠé—­åŒ…å½“ä½œå‚æ•°æ—¶ï¼Œå¯ä»¥ç›´æ¥å£°æ˜ä¸ºé—­åŒ…ç±»å‹å¦‚ `Fn(i32) -> i32`ï¼Œè¿™æ˜¯å› ä¸ºå‡½æ•°ä½“å†…çš„**å‚æ•°é—­åŒ…**æœ‰ä¸”åªæœ‰ä¸€ç§é—­åŒ…ç±»å‹ï¼ŒRust é€šè¿‡ä½¿ç”¨**trait ç•Œå®šï¼ˆtrait boundsï¼‰**å…è®¸å‡½æ•°æ¥å—ä»»ä½•å®ç°äº†æŒ‡å®š trait çš„ç±»å‹ã€‚
å¯ä»¥ç†è§£æˆ Rust è‡ªåŠ¨æ¨æ–­ä¸º `impl trait` å½¢å¼ã€‚è¿™ç§å‚æ•°é—­åŒ…ç›´æ¥å£°æ˜ä¸ºé—­åŒ…ç±»å‹çš„æ–¹å¼æä¾›äº†è¶³å¤Ÿçš„çµæ´»æ€§ï¼ŒåŒæ—¶é¿å…äº† impl Trait ç›´æ¥åœ¨å‚æ•°ä½ç½®çš„ä½¿ç”¨ã€‚

å…¶æ¬¡ï¼Œé—­åŒ…ä½œä¸ºè¿”å›å€¼æ—¶ï¼Œä¸ºäº†éµå®ˆ â€œRust è¦æ±‚å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼çš„å†…å­˜å¤§å°æ˜¯å›ºå®šçš„â€ çš„åŸåˆ™ï¼Œä¸èƒ½ç›´æ¥å°†é—­åŒ…ç±»å‹ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼å£°æ˜ï¼Œè€Œåº”è¯¥ä½¿ç”¨ `impl trait` æˆ–ç‰¹å¾å¯¹è±¡ã€‚
å¦‚æœåªæœ‰ä¸€ç§é—­åŒ…ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨ `impl trait` å½¢å¼ï¼Œå¦‚ `impl Fn(i32) -> i32`ï¼Œè¡¨æ˜è¿”å›ä¸€ä¸ªå®ç°äº†æŒ‡å®š trait çš„ç±»å‹ï¼Œimpl Trait å½¢å¼æ¥è¯´æ˜ä¸€ä¸ªå‡½æ•°è¿”å›äº†ä¸€ä¸ªç±»å‹ï¼Œè¯¥ç±»å‹å®ç°äº†æŸä¸ªç‰¹å¾ï¼Œå¤–éƒ¨ä½¿ç”¨æ—¶åªèƒ½ä½¿ç”¨è¯¥ç‰¹å¾å·²å£°æ˜çš„å±æ€§ï¼Œå› æ­¤æ˜¯å›ºå®šå¤§å°çš„ã€‚(å‡½æ•°è¿”å›ä¸­çš„ impl trait)[https://course.rs/basic/trait/trait.html#%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E4%B8%AD%E7%9A%84-impl-trait]
å¦‚æœå­˜åœ¨å¤šä¸ªé—­åŒ…ç±»å‹ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ç‰¹å¾å¯¹è±¡ `Box<dyn Fn(i32) -> i32>` æ¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚

> å¤šä¸ªé—­åŒ…ç±»å‹å³å¤šä¸ªä½ç½®å£°æ˜å®šä¹‰çš„é—­åŒ…ï¼Œæ¯ä¸ªé—­åŒ…éƒ½æœ‰å…¶è‡ªå·±ç‹¬ç‰¹çš„åŒ¿åç±»å‹ï¼ˆè¿™ä¸ªç±»å‹å°±æ˜¯ç±»ä¼¼ `i32 String` çš„ä¸€ç§æ•°æ®æ ¼å¼ç±»å‹ï¼‰ï¼Œè¿™æ˜¯å› ä¸º**é—­åŒ…ç±»å‹ä¸ä»…ä»…æ˜¯ç”±å…¶å‚æ•°å’Œè¿”å›ç±»å‹å®šä¹‰**çš„ï¼Œè¿˜åŒ…æ‹¬å®ƒæ•è·çš„ç¯å¢ƒã€‚æ¯ä¸ªé—­åŒ…æ ¹æ®å…¶æ•è·çš„ç¯å¢ƒï¼ˆå˜é‡ã€ç”Ÿå‘½å‘¨æœŸç­‰ï¼‰å…·æœ‰ä¸åŒçš„ç±»å‹ã€‚

åŒæ—¶ï¼Œå½“å‡½æ•°è¿”å›é—­åŒ…æ—¶ï¼Œéœ€è¦æ³¨æ„è¿”å›çš„é—­åŒ…æ˜¯å¦å…·æœ‰å˜é‡çš„æ‰€æœ‰æƒï¼Œå› ä¸ºåªæœ‰é—­åŒ…è·å–äº†å˜é‡çš„æ‰€æœ‰æƒï¼Œåœ¨å½“å‰å‡½æ•°æ‰§è¡Œç»“æŸè¿”å›åï¼Œå˜é‡æ‰ä¸ä¼šè¢«é‡Šæ”¾ï¼Œæ‰ä¸ä¼šå‡ºç°å¼•ç”¨é—®é¢˜ã€‚å½“é—­åŒ…ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼è¿”å›æ—¶ï¼Œå¸¸è§çš„é—­åŒ…éƒ½ä¼šæœ‰ `move` å…³é”®å­—å¼ºåˆ¶è·å–å˜é‡çš„æ‰€æœ‰æƒã€‚

### & mut &mut çš„å„ç§ä½ç½®è®¤è¯†

é˜…è¯»ï¼šhttps://github.com/sunface/rust-course/discussions/619#discussioncomment-2623736

- fn do1(c: String) {}ï¼šè¡¨ç¤ºå®å‚ä¼šå°†æ‰€æœ‰æƒä¼ é€’ç»™ c
- fn do2(c: &String) {}ï¼šè¡¨ç¤ºå®å‚çš„ä¸å¯å˜å¼•ç”¨ï¼ˆæŒ‡é’ˆï¼‰ä¼ é€’ç»™ cï¼Œå®å‚éœ€å¸¦ & å£°æ˜
- fn do3(c: &mut String) {}ï¼šè¡¨ç¤ºå®å‚å¯å˜å¼•ç”¨ï¼ˆæŒ‡é’ˆï¼‰ä¼ é€’ç»™ cï¼Œå®å‚éœ€å¸¦ let mut å£°æ˜ï¼Œä¸”ä¼ å…¥éœ€å¸¦ &mut
- fn do4(mut c: String) {}ï¼šè¡¨ç¤ºå®å‚ä¼šå°†æ‰€æœ‰æƒä¼ é€’ç»™ cï¼Œä¸”åœ¨å‡½æ•°ä½“å†… c æ˜¯å¯è¯»å¯å†™çš„ï¼Œå®å‚æ— éœ€ mut å£°æ˜
- fn do5(mut c: &mut String) {}ï¼šè¡¨ç¤ºå®å‚å¯å˜å¼•ç”¨æŒ‡å‘çš„å€¼ä¼ é€’ç»™ cï¼Œä¸” c åœ¨å‡½æ•°ä½“å†…éƒ¨æ˜¯å¯è¯»å¯å†™çš„ï¼Œå®å‚éœ€å¸¦ let mut å£°æ˜ï¼Œä¸”ä¼ å…¥éœ€å¸¦ &mut

ä¸€å¥è¯æ€»ç»“ï¼šåœ¨å‡½æ•°å‚æ•°ä¸­ï¼Œå†’å·å·¦è¾¹çš„éƒ¨åˆ†ï¼Œå¦‚ï¼šmut cï¼Œè¿™ä¸ª mut æ˜¯å¯¹ ğŸª„ å‡½æ•°ä½“å†…éƒ¨æœ‰æ•ˆ ğŸª„ï¼›å†’å·å³è¾¹çš„éƒ¨åˆ†ï¼Œå¦‚ï¼š&mut Stringï¼Œè¿™ä¸ª &mut æ˜¯é’ˆå¯¹ ğŸª„ å¤–éƒ¨å®å‚ä¼ å…¥æ—¶çš„å½¢å¼ï¼ˆå£°æ˜ï¼‰è¯´æ˜ ğŸª„ã€‚

### é˜…è¯»

- [æ³›å‹ã€ç‰¹å¾ã€ç‰¹å¾å¯¹è±¡](https://course.rs/basic/trait/intro.html)
- [é—­åŒ…çš„ä½¿ç”¨æ¡ˆä¾‹](https://www.cnblogs.com/lilpig/p/17022845.html#%E5%A4%8D%E6%9D%82%E4%B8%80%E7%82%B9%E6%8A%8A%E9%97%AD%E5%8C%85%E7%94%A8%E5%9C%A8%E5%87%BD%E6%95%B0%E4%B8%8A)

### Code

```rust
fn main {
    let x = 2;
    let closure = || println!("{}", x);

    fn factory() -> impl Fn(i32) -> i32 {
        let x = 2;
        let closure = move |a| x + a;
        closure
    }

    let f = factory();
    println!("{}", f(1));

    // impl trait åªå…è®¸ä¸€ç§å…·ä½“çš„ç±»å‹ï¼Œåœ¨æœ‰å¤šç§ç±»å‹è¿”å›å€¼æ—¶ä¸é€‚ç”¨
    // fn factory(x: i32) -> impl Fn(i32) -> i32 {
    //     let num = 5;
    //     if x > 1 {
    //         |x| x + num
    //     } else {
    //         |x| x - num
    //     }
    // }

    fn factoryDyn(x: i32) -> Box<dyn Fn(i32) -> i32> {
        let num = 5;

        if x > 1 {
            Box::new(move |x| x + num)
        } else {
            Box::new(move |x| x - num)
        }
    }
}
```
